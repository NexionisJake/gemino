import React, { useState } from 'react';
import CodeModal from './CodeModal';

import { GlowingEffect } from '@/components/ui/GlowingEffect';
import { TextShimmer } from '@/components/ui/TextShimmer';

const VulnerabilityCard = ({ vuln, onViewCode, onPatch }) => {
    const [patched, setPatched] = useState(false);
    const [patching, setPatching] = useState(false);

    const handlePatch = async () => {
        setPatching(true);
        try {
            await onPatch(vuln);
            setPatched(true);
        } catch (e) {
            console.error(e);
        } finally {
            setPatching(false);
        }
    };

    return (
        <div className="relative h-full rounded-[1.25rem] border-[0.75px] border-white/10 p-2 md:rounded-[1.5rem] md:p-3 mb-4">
            <GlowingEffect
                spread={40}
                glow={true}
                disabled={false}
                proximity={64}
                inactiveZone={0.01}
                borderWidth={3}
                variant={patched ? "default" : "default"} // Could toggle variant if needed
            />
            <div className={`relative flex h-full flex-col justify-between gap-6 overflow-hidden rounded-xl border-[0.75px] bg-bg-void/80 p-6 shadow-sm ${patched ? 'border-status-success' : 'border-status-danger'} backdrop-blur-md`}>
                <div className="flex justify-between items-start">
                    <div>
                        <h3 className={`${patched ? 'text-status-success' : 'text-status-danger'} font-rajdhani font-bold text-lg`}>
                            {patched ? 'PATCHED: ' : ''}{vuln.type}
                        </h3>
                        <p className="text-text-dim text-xs font-mono mb-1">{vuln.file}:{vuln.line}</p>
                    </div>
                    {!patched && (
                        <span className="px-2 py-0.5 rounded bg-status-danger/20 text-status-danger text-xs font-bold border border-status-danger/50">
                            HIGH
                        </span>
                    )}
                </div>
                <p className="text-text-main text-sm mt-2">{vuln.description}</p>
                <div className="mt-3 flex gap-2">
                    <button
                        onClick={() => onViewCode(vuln.file)}
                        className="text-xs bg-primary-neon/10 text-primary-neon px-3 py-1 rounded hover:bg-primary-neon/20 transition-colors border border-primary-neon/30"
                    >
                        VIEW CODE
                    </button>
                    {!patched && (
                        <button
                            onClick={handlePatch}
                            disabled={patching}
                            className="text-xs bg-status-success/10 text-status-success px-3 py-1 rounded hover:bg-status-success/20 transition-colors border border-status-success/30 disabled:opacity-50 min-w-[100px]"
                        >
                            {patching ? (
                                <TextShimmer className='text-sm' duration={1.5}>PATCHING...</TextShimmer>
                            ) : 'AUTO-PATCH'}
                        </button>
                    )}
                </div>
            </div>
        </div>
    );
};

const VulnerabilityReport = ({ vulnerabilities }) => {
    const [selectedFile, setSelectedFile] = useState(null);

    const handlePatchBackend = async (vuln) => {
        // Call backend to patch
        const res = await fetch('http://localhost:8000/api/auto_patch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ vulnerability: vuln, file: vuln.file })
        });
        if (!res.ok) throw new Error('Patch failed');
    };

    return (
        <div className="flex flex-col h-full relative">
            {selectedFile && <CodeModal file={selectedFile} onClose={() => setSelectedFile(null)} />}

            <h2 className="text-xl font-rajdhani font-bold text-white mb-4 flex items-center gap-2">
                <span className="text-status-danger">âš </span> THREAT DETECTION
                <span className="ml-auto text-sm font-mono text-text-dim bg-white/5 px-2 py-1 rounded">
                    COUNT: {vulnerabilities.length}
                </span>
            </h2>

            <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                {vulnerabilities.length === 0 ? (
                    <div className="flex flex-col items-center justify-center h-48 text-text-dim opacity-50 border border-dashed border-white/10 rounded-xl">
                        <span className="text-4xl mb-2">ðŸ›¡</span>
                        <span>System Secure. No threats detected.</span>
                    </div>
                ) : (
                    vulnerabilities.map((vuln, index) => (
                        <VulnerabilityCard
                            key={index}
                            vuln={vuln}
                            onViewCode={setSelectedFile}
                            onPatch={handlePatchBackend}
                        />
                    ))
                )}
            </div>
        </div>
    );
};

export default VulnerabilityReport;
